# 解析原始 Calldata 数据

## encode calldata

`transfer_calldata = abi.encodeCall(IERC20.transfer, (to, amount))`

## decode calldata

`abi.decode(transfer_calldata[4:], (address, uint256))`

## pretty-calldata

`cast pretty-calldata [CALLDATA]`
优雅打印 calldata 数据。尝试使用 https://openchain.xyz 解码 calldata 数据。

```shell
cast pretty-calldata 0xa9059cbb00000000000000000000000009f7e47b2aad6cd48b56f223731ce76194338ca4000000000000000000000000000000000000000000000000000000174234bbc0
```

输出：

```
 Possible methods:
 - execute(address,bytes)
 ------------
 [000]: 0000000000000000000000001240fa2a84dd9157a0e76b5cfe98b1d52268b264
 [020]: 0000000000000000000000000000000000000000000000000000000000000040
 [040]: 0000000000000000000000000000000000000000000000000000000000000044
 [060]: 85fb709d00000000000000000000000073030b99950fb19c6a813465e58a0bca
 [080]: 5487fbea0000000000000000000000008ad159a275aee56fb2334dbb69036e9c
 [0a0]: 7bacee9b00000000000000000000000000000000000000000000000000000000
```

## 1. 全静态参数

静态变量：uint, int, address, bool, bytes1, ..., bytes32。

```
cast pretty-calldata 0xa9059cbb00000000000000000000000009f7e47b2aad6cd48b56f223731ce76194338ca4000000000000000000000000000000000000000000000000000000174234bbc0

 Possible methods:
 - transfer(address,uint256)
 ------------
 [000]: 00000000000000000000000009f7e47b2aad6cd48b56f223731ce76194338ca4
 [020]: 000000000000000000000000000000000000000000000000000000174234bbc0

```

每个元素填充为`32字节`，然后顺序排列。

`00000000000000000000000009f7e47b2aad6cd48b56f223731ce76194338ca4`为元素`address`的值，

`000000000000000000000000000000000000000000000000000000174234bbc0`为元素`uint256`的值。

## 2. 固定长度数组

固定长度数组，将数组展开，如果元素是静态，排列的是原始值；如果元素是动态，排列的是偏移量。

### 1. 元素为静态

transfer(address[2],uint256[2]) ==>transfer(address,address,uint256,uint256)

a_calldata[4:] === b_calldata[4:]

```
cast pretty-calldata 0xb26498070000000000000000000000005b38da6a701c568545dcfcb03fcb875f56beddc4000000000000000000000000ab8483f64d9c6d1ecf9b849ae677dd3315835cb2000000000000000000000000000000000000000000000000000000000000006400000000000000000000000000000000000000000000000000000000000000c8

 Possible methods:
 - transfer(address[2],uint256[2])
 ------------
 [000]: 0000000000000000000000005b38da6a701c568545dcfcb03fcb875f56beddc4
 [020]: 000000000000000000000000ab8483f64d9c6d1ecf9b849ae677dd3315835cb2
 [040]: 0000000000000000000000000000000000000000000000000000000000000064
 [060]: 00000000000000000000000000000000000000000000000000000000000000c8
```

### 2. 元素为动态

```
cast pretty-calldata 0xf1a01c57000000000000000000000000000000000000000000000000000000000000006400000000000000000000000000000000000000000000000000000000000000c80000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000001020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000031111110000000000000000000000000000000000000000000000000000000000

 Possible methods:
 - transfer(address[2],bytes[2])
 ------------
 [000]: 0000000000000000000000005b38da6a701c568545dcfcb03fcb875f56beddc4
 [020]: 0000000000000000000000005b38da6a701c568545dcfcb03fcb875f56beddc5
 [040]: 0000000000000000000000000000000000000000000000000000000000000060
   [060]: 0000000000000000000000000000000000000000000000000000000000000040
   [080]: 0000000000000000000000000000000000000000000000000000000000000080
   [0a0]: 0000000000000000000000000000000000000000000000000000000000000001
   [0c0]: 1100000000000000000000000000000000000000000000000000000000000000
   [0e0]: 0000000000000000000000000000000000000000000000000000000000000003
   [100]: aaaaaa0000000000000000000000000000000000000000000000000000000000
```

transfer(address[2] memory accounts,bytes[2] memory datas)

accounts 的元素为静态，accounts[0],accounts[1]依次顺序排列，`0000000000000000000000005b38da6a701c568545dcfcb03fcb875f56beddc4`,`0000000000000000000000005b38da6a701c568545dcfcb03fcb875f56beddc5`。

> [!IMPORTANT]
> 因为 datas 元素包含为动态元素，不能展开，`0000000000000000000000000000000000000000000000000000000000000060`为 datas 偏移量；

因为 datas 长度固定，无需指定长度，datas[0]和 datas[1]是动态元素，则`0000000000000000000000000000000000000000000000000000000000000040`为 datas[0]的偏移量，`0000000000000000000000000000000000000000000000000000000000000080`为 datas[1]的偏移量；

`0x40`+`0x60` =`0xa0`, `0000000000000000000000000000000000000000000000000000000000000001`为 datas[0]的长度，其值为`0x11`;

`0x80`+`0x60` =`0xe0`, `0000000000000000000000000000000000000000000000000000000000000003`为 datas[1]的长度，其值为`0xaaaaaa`;

> [!CAUTION]
>
> datas[0]确切位置为什么`+ 0x60`，而不是直接使用偏移量？
>
> `0000000000000000000000000000000000000000000000000000000000000040`存储的是`相对偏移量`，address[0], adress[1], datas 的偏移量在同一纬度，而 datas[0]，datas[1]在他们下一维度，所以`相对偏移量 + 本维度开始位置 = 元素真正开始位置`。

## 3. 全动态参数

动态变量: bytes、string 和动态数组<T>[]。

```
cast pretty-calldata 0xffc3a769000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000005b38da6a701c568545dcfcb03fcb875f56beddc4000000000000000000000000ab8483f64d9c6d1ecf9b849ae677dd3315835cb20000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000006400000000000000000000000000000000000000000000000000000000000000c8

 Possible methods:
 - transfer(address[],uint256[])
 ------------
 [000]: 0000000000000000000000000000000000000000000000000000000000000040
 [020]: 00000000000000000000000000000000000000000000000000000000000000a0
 [040]: 0000000000000000000000000000000000000000000000000000000000000002
 [060]: 0000000000000000000000005b38da6a701c568545dcfcb03fcb875f56beddc4
 [080]: 000000000000000000000000ab8483f64d9c6d1ecf9b849ae677dd3315835cb2
 [0a0]: 0000000000000000000000000000000000000000000000000000000000000002
 [0c0]: 0000000000000000000000000000000000000000000000000000000000000064
 [0e0]: 00000000000000000000000000000000000000000000000000000000000000c8

```

transfer(address[] memory tos,uint256[] memory amounts)

tos 为动态数组，`0000000000000000000000000000000000000000000000000000000000000040`为 tos 的偏移量，`0000000000000000000000000000000000000000000000000000000000000002`为 tos 的长度，`0000000000000000000000005b38da6a701c568545dcfcb03fcb875f56beddc4`为 tos[0]的值，`000000000000000000000000ab8483f64d9c6d1ecf9b849ae677dd3315835cb2`为 tos[1]的值。

amounts 为动态数组，`00000000000000000000000000000000000000000000000000000000000000a0`为 amounts 的偏移量，`0000000000000000000000000000000000000000000000000000000000000002`为 amounts 的长度，`0000000000000000000000000000000000000000000000000000000000000064`为 amounts[0]的值，`00000000000000000000000000000000000000000000000000000000000000c8`为 amounts[1]的值。

> [!IMPORTANT]
>
> 1. 什么情况下存储的是偏移量？
>
> 参数 a 是动态数组或参数 a 的元素包含动态元素。
>
> 2. 什么情况下参数 a 需要直接展开？
>
> 参数 a 的元素全部为静态类型。
>
> 3. 什么情况下参数 a 有长度数据需要保存？
>
> 参数 a 为动态数组或 bytes/string。
>
> 4. 元素真正开始位置？
>
>    `相对偏移量 + 本维度开始位置 = 元素真正开始位置`

# 4. 结构体参数

静态结构体：元素全为静态。

动态结构体：元素包含动态。

### 1. 静态结构体

```
  struct Para {
        address to;
        uint256 amount;
    }

    function transfer(Para calldata para);
```

```
cast pretty-calldata 0x2bd14bb90000000000000000000000005b38da6a701c568545dcfcb03fcb875f56beddc40000000000000000000000000000000000000000000000000000000000002710

 Method: 2bd14bb9
 ------------
 [000]: 0000000000000000000000005b38da6a701c568545dcfcb03fcb875f56beddc4
 [020]: 0000000000000000000000000000000000000000000000000000000000002710
```

para 的元素为 address 和 uint256 类型，全为静态类型，需要展开。

transfer(Para calldata para) ==> transfer(address to, uint256 amount)

a_calldata[4:] === b_calldata[4:]

### 2. 动态结构体

```
    struct Paras {
        address to;
        uint256 amount;
        bytes data;
    }

    function transfer(Paras calldata paras);
```

```
cast pretty-calldata 0x48d2107f00000000000000000000000000000000000000000000000000000000000000200000000000000000000000005b38da6a701c568545dcfcb03fcb875f56beddc40000000000000000000000000000000000000000000000000000000000002710000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000051234567890000000000000000000000000000000000000000000000000000000

 Method: 48d2107f
 ------------
 [000]: 0000000000000000000000000000000000000000000000000000000000000020
   [020]: 0000000000000000000000005b38da6a701c568545dcfcb03fcb875f56beddc4
   [040]: 0000000000000000000000000000000000000000000000000000000000002710
   [060]: 0000000000000000000000000000000000000000000000000000000000000060
   [080]: 0000000000000000000000000000000000000000000000000000000000000005
   [0a0]: 1234567890000000000000000000000000000000000000000000000000000000
```

paras 包含动态元素，`0000000000000000000000000000000000000000000000000000000000000020`为 paras 的偏移量，paras 不是动态数组，`0000000000000000000000005b38da6a701c568545dcfcb03fcb875f56beddc4`为 paras.to 的值，`0000000000000000000000000000000000000000000000000000000000002710`为 paras.amount 的值；paras.data 为动态类型，`0000000000000000000000000000000000000000000000000000000000000060`为 paras.data 的偏移量，`0x60 + 0x20 = 0x80`，`0000000000000000000000000000000000000000000000000000000000000005`为 paras.data 的长度，paras.data 的值为`0x1234567890`。
